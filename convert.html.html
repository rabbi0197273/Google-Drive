<script src="photos-data.js"></script>
<script>
    // API Keys for Google Drive
    var apiKeys = [
        'AIzaSyCt3DULzE2trDJhfFUosWZT-3GEObbMqVU', 
        'AIzaSyCsbx8BSyLwkw6XX6Lg5OF1U0HNtI9VmCY', 
        'AIzaSyBLMJAT6oqTZxAMsCsMjXzoo4lkJL4MmfM', 
        'AIzaSyCIY6fomcJxOt0XQ_naa1rzfd5wlOMGKDY'
    ];
    var currentApiKey = apiKeys[Math.floor(Math.random() * apiKeys.length)];
    
    let currentPhoto = {};

    // Extract Google Drive ID from URL - IMPROVED
    function extractDriveId(url) {
        console.log('Input URL:', url);
        url = url.trim();
        
        // Pattern 1: https://drive.google.com/file/d/FILE_ID/view
        let match = url.match(/\/file\/d\/([a-zA-Z0-9-_]+)/);
        if (match) {
            console.log('Extracted ID (Pattern 1):', match[1]);
            return match[1];
        }
        
        // Pattern 2: https://drive.google.com/open?id=FILE_ID
        match = url.match(/[?&]id=([a-zA-Z0-9-_]+)/);
        if (match) {
            console.log('Extracted ID (Pattern 2):', match[1]);
            return match[1];
        }
        
        // Pattern 3: Direct ID
        if (url.match(/^[a-zA-Z0-9-_]{25,}$/)) {
            console.log('Direct ID:', url);
            return url;
        }
        
        console.log('No ID found');
        return null;
    }

    function convertPhoto() {
        const photoUrl = document.getElementById('photoUrl').value.trim();
        const photoTitle = document.getElementById('photoTitle').value.trim() || 'Untitled Photo';
        
        console.log('Starting conversion...');
        console.log('Photo URL:', photoUrl);
        console.log('Photo Title:', photoTitle);
        
        // Hide previous results
        hideAllDisplays();
        
        if (!photoUrl) {
            showError('Please enter a Google Drive photo link!');
            return;
        }
        
        // Extract Drive ID
        const driveId = extractDriveId(photoUrl);
        if (!driveId) {
            showError('Invalid Google Drive link! Please use a proper sharing link.');
            return;
        }
        
        console.log('Drive ID:', driveId);
        
        // Show loading
        const loadingDiv = document.getElementById('loadingDiv');
        if (loadingDiv) loadingDiv.style.display = 'block';
        
        // Generate all possible links
        const directLink = `https://www.googleapis.com/drive/v3/files/${driveId}?alt=media&key=${currentApiKey}`;
        const thumbnailLink = `https://lh3.googleusercontent.com/d/${driveId}`;
        const driveDirectLink = `https://drive.google.com/uc?export=view&id=${driveId}`;
        const base64Id = btoa(JSON.stringify({id: driveId}));
        const viewerLink = `${window.location.origin}${window.location.pathname.replace('convert.html', '')}photos.html?id=${base64Id}`;
        
        console.log('Generated Links:');
        console.log('Direct Link:', directLink);
        console.log('Thumbnail:', thumbnailLink);
        console.log('Drive Direct:', driveDirectLink);
        console.log('Viewer Link:', viewerLink);
        
        // Test multiple image sources
        testImageSources([thumbnailLink, driveDirectLink, directLink], {
            id: base64Id,
            title: photoTitle,
            driveId: driveId,
            directLink: directLink,
            thumbnail: thumbnailLink,
            driveDirectLink: driveDirectLink,
            viewerLink: viewerLink
        });
    }

    function testImageSources(sources, photoData) {
        let sourceIndex = 0;
        
        function tryNextSource() {
            if (sourceIndex >= sources.length) {
                showError('Cannot access this photo. Please ensure:\n1. Photo is publicly accessible\n2. Sharing is enabled\n3. Link is correct');
                return;
            }
            
            const currentSource = sources[sourceIndex];
            console.log(`Testing source ${sourceIndex + 1}:`, currentSource);
            
            const testImg = new Image();
            testImg.onload = function() {
                console.log('‚úÖ Image loaded successfully from:', currentSource);
                
                // Use the working source as primary
                photoData.workingSource = currentSource;
                photoData.thumbnail = currentSource;
                
                displayResults(photoData);
                
                // Save to storage
                const saved = savePhoto(photoData);
                if (saved) {
                    console.log('üíæ Photo saved to gallery');
                } else {
                    console.log('‚ö†Ô∏è Photo already exists in gallery');
                }
            };
            
            testImg.onerror = function() {
                console.log(`‚ùå Failed to load from source ${sourceIndex + 1}`);
                sourceIndex++;
                setTimeout(tryNextSource, 1000); // Try next source after 1 second
            };
            
            testImg.src = currentSource;
        }
        
        tryNextSource();
    }

    function displayResults(photoData) {
        hideAllDisplays();
        
        currentPhoto = photoData;
        
        console.log('Displaying results:', photoData);
        
        // Update preview image with working source
        const previewImg = document.getElementById('previewImage');
        if (previewImg) {
            previewImg.src = photoData.workingSource || photoData.thumbnail;
            previewImg.style.display = 'block';
        }
        
        // Update link displays
        const directLinkElement = document.getElementById('directLinkText') || document.getElementById('directLink');
        const thumbnailElement = document.getElementById('thumbnailText') || document.getElementById('thumbnailLink');
        const viewerLinkElement = document.getElementById('viewerLinkText') || document.getElementById('viewerLink');
        
        if (directLinkElement) directLinkElement.textContent = photoData.directLink;
        if (thumbnailElement) thumbnailElement.textContent = photoData.thumbnail;
        if (viewerLinkElement) viewerLinkElement.textContent = photoData.viewerLink;
        
        // Show results section
        const resultDisplay = document.getElementById('resultDisplay');
        if (resultDisplay) {
            resultDisplay.style.display = 'block';
        }
        
        console.log('‚úÖ Results displayed successfully');
    }

    function hideAllDisplays() {
        const elements = ['loadingDiv', 'resultDisplay', 'errorDisplay'];
        elements.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.style.display = 'none';
        });
    }

    function showError(message) {
        console.log('‚ùå Error:', message);
        hideAllDisplays();
        
        const errorDisplay = document.getElementById('errorDisplay');
        const errorMessage = document.getElementById('errorMessage');
        
        if (errorDisplay && errorMessage) {
            errorMessage.textContent = message;
            errorDisplay.style.display = 'block';
        } else {
            alert(message); // Fallback
        }
    }

    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        const text = element ? element.textContent : '';
        
        if (!text) {
            alert('No text to copy!');
            return;
        }
        
        navigator.clipboard.writeText(text).then(() => {
            // Visual feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úÖ Copied!';
            btn.style.backgroundColor = '#10b981';
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.backgroundColor = '';
            }, 2000);
            
            console.log('üìã Copied to clipboard:', text);
        }).catch(() => {
            // Fallback
            prompt('Copy this link:', text);
        });
    }

    function openInViewer() {
        if (currentPhoto.driveId) {
            const base64Id = btoa(JSON.stringify({id: currentPhoto.driveId}));
            window.location.href = `photos.html?id=${base64Id}`;
        }
    }

    function downloadImage() {
        if (currentPhoto.directLink) {
            const a = document.createElement('a');
            a.href = currentPhoto.workingSource || currentPhoto.directLink;
            a.download = currentPhoto.title + '.jpg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            console.log('‚¨áÔ∏è Download initiated');
        }
    }

    function resetForm() {
        const photoUrlInput = document.getElementById('photoUrl');
        const photoTitleInput = document.getElementById('photoTitle');
        
        if (photoUrlInput) photoUrlInput.value = '';
        if (photoTitleInput) photoTitleInput.value = '';
        
        hideAllDisplays();
        currentPhoto = {};
        console.log('üîÑ Form reset');
    }

    // Auto-extract title from URL if possible
    const photoUrlInput = document.getElementById('photoUrl');
    if (photoUrlInput) {
        photoUrlInput.addEventListener('input', function() {
            const url = this.value;
            const titleInput = document.getElementById('photoTitle');
            
            if (url && titleInput && !titleInput.value) {
                // Try to extract filename from URL
                const match = url.match(/[?&]title=([^&]+)/);
                if (match) {
                    titleInput.value = decodeURIComponent(match[1]);
                }
            }
        });
    }

    console.log('üöÄ PhotoPlyr Converter initialized');
                </script>
